From 6016b5eba47b50bf9efea04276f5b44720393bb7 Mon Sep 17 00:00:00 2001
From: Frank van der Linden <fllinden@amazon.com>
Date: Fri, 1 Mar 2019 17:59:57 +0000
Subject: Config glue for lustre client.

Signed-off-by: Frank van der Linden <fllinden@amazon.com>
---
 drivers/staging/Kconfig                       |  2 +
 drivers/staging/Makefile                      |  1 +
 drivers/staging/lustrefsx/Kconfig             |  3 ++
 drivers/staging/lustrefsx/Makefile            |  3 ++
 drivers/staging/lustrefsx/Makefile.rules      |  6 +++
 drivers/staging/lustrefsx/libcfs/Kconfig      |  3 ++
 drivers/staging/lustrefsx/libcfs/Makefile     |  1 +
 .../staging/lustrefsx/libcfs/libcfs/Makefile  | 19 +++++++++
 drivers/staging/lustrefsx/list                | 26 ++++++++++++
 drivers/staging/lustrefsx/lnet/Kconfig        | 37 +++++++++++++++++
 drivers/staging/lustrefsx/lnet/Makefile       |  3 ++
 drivers/staging/lustrefsx/lnet/klnds/Makefile |  2 +
 .../lustrefsx/lnet/klnds/o2iblnd/Makefile     |  5 +++
 .../lustrefsx/lnet/klnds/socklnd/Makefile     |  6 +++
 drivers/staging/lustrefsx/lnet/lnet/Makefile  |  8 ++++
 .../staging/lustrefsx/lnet/selftest/Makefile  |  6 +++
 drivers/staging/lustrefsx/lustre/Kconfig      | 41 +++++++++++++++++++
 drivers/staging/lustrefsx/lustre/Makefile     |  8 ++++
 drivers/staging/lustrefsx/lustre/fid/Makefile |  5 +++
 drivers/staging/lustrefsx/lustre/fld/Makefile |  8 ++++
 .../staging/lustrefsx/lustre/llite/Makefile   | 13 ++++++
 drivers/staging/lustrefsx/lustre/lmv/Makefile |  5 +++
 drivers/staging/lustrefsx/lustre/lov/Makefile |  8 ++++
 drivers/staging/lustrefsx/lustre/mdc/Makefile |  6 +++
 drivers/staging/lustrefsx/lustre/mgc/Makefile |  5 +++
 .../lustrefsx/lustre/obdclass/Makefile        | 16 ++++++++
 .../staging/lustrefsx/lustre/obdecho/Makefile |  5 +++
 drivers/staging/lustrefsx/lustre/osc/Makefile |  6 +++
 .../staging/lustrefsx/lustre/ptlrpc/Makefile  | 26 ++++++++++++
 29 files changed, 283 insertions(+)
 create mode 100644 drivers/staging/lustrefsx/Kconfig
 create mode 100644 drivers/staging/lustrefsx/Makefile
 create mode 100644 drivers/staging/lustrefsx/Makefile.rules
 create mode 100644 drivers/staging/lustrefsx/libcfs/Kconfig
 create mode 100644 drivers/staging/lustrefsx/libcfs/Makefile
 create mode 100644 drivers/staging/lustrefsx/libcfs/libcfs/Makefile
 create mode 100644 drivers/staging/lustrefsx/list
 create mode 100644 drivers/staging/lustrefsx/lnet/Kconfig
 create mode 100644 drivers/staging/lustrefsx/lnet/Makefile
 create mode 100644 drivers/staging/lustrefsx/lnet/klnds/Makefile
 create mode 100644 drivers/staging/lustrefsx/lnet/klnds/o2iblnd/Makefile
 create mode 100644 drivers/staging/lustrefsx/lnet/klnds/socklnd/Makefile
 create mode 100644 drivers/staging/lustrefsx/lnet/lnet/Makefile
 create mode 100644 drivers/staging/lustrefsx/lnet/selftest/Makefile
 create mode 100644 drivers/staging/lustrefsx/lustre/Kconfig
 create mode 100644 drivers/staging/lustrefsx/lustre/Makefile
 create mode 100644 drivers/staging/lustrefsx/lustre/fid/Makefile
 create mode 100644 drivers/staging/lustrefsx/lustre/fld/Makefile
 create mode 100644 drivers/staging/lustrefsx/lustre/llite/Makefile
 create mode 100644 drivers/staging/lustrefsx/lustre/lmv/Makefile
 create mode 100644 drivers/staging/lustrefsx/lustre/lov/Makefile
 create mode 100644 drivers/staging/lustrefsx/lustre/mdc/Makefile
 create mode 100644 drivers/staging/lustrefsx/lustre/mgc/Makefile
 create mode 100644 drivers/staging/lustrefsx/lustre/obdclass/Makefile
 create mode 100644 drivers/staging/lustrefsx/lustre/obdecho/Makefile
 create mode 100644 drivers/staging/lustrefsx/lustre/osc/Makefile
 create mode 100644 drivers/staging/lustrefsx/lustre/ptlrpc/Makefile

diff --git a/drivers/staging/Kconfig b/drivers/staging/Kconfig
index 2d0310448eba..7ac7b7125916 100644
--- a/drivers/staging/Kconfig
+++ b/drivers/staging/Kconfig
@@ -70,6 +70,8 @@ source "drivers/staging/fwserial/Kconfig"
 
 source "drivers/staging/goldfish/Kconfig"
 
+source "drivers/staging/lustrefsx/Kconfig"
+
 source "drivers/staging/netlogic/Kconfig"
 
 source "drivers/staging/gs_fpgaboot/Kconfig"
diff --git a/drivers/staging/Makefile b/drivers/staging/Makefile
index 757a892ab5b9..968031df9e11 100644
--- a/drivers/staging/Makefile
+++ b/drivers/staging/Makefile
@@ -26,6 +26,7 @@ obj-$(CONFIG_STAGING_BOARD)	+= board/
 obj-$(CONFIG_LTE_GDM724X)	+= gdm724x/
 obj-$(CONFIG_FIREWIRE_SERIAL)	+= fwserial/
 obj-$(CONFIG_GOLDFISH)		+= goldfish/
+obj-$(CONFIG_LUSTREFSX_LNET)	+= lustrefsx/
 obj-$(CONFIG_GS_FPGABOOT)	+= gs_fpgaboot/
 obj-$(CONFIG_UNISYSSPAR)	+= unisys/
 obj-$(CONFIG_COMMON_CLK_XLNX_CLKWZRD)	+= clocking-wizard/
diff --git a/drivers/staging/lustrefsx/Kconfig b/drivers/staging/lustrefsx/Kconfig
new file mode 100644
index 000000000000..81e9bc1043d7
--- /dev/null
+++ b/drivers/staging/lustrefsx/Kconfig
@@ -0,0 +1,3 @@
+source "drivers/staging/lustrefsx/libcfs/Kconfig"
+source "drivers/staging/lustrefsx/lnet/Kconfig"
+source "drivers/staging/lustrefsx/lustre/Kconfig"
diff --git a/drivers/staging/lustrefsx/Makefile b/drivers/staging/lustrefsx/Makefile
new file mode 100644
index 000000000000..20c7929213c3
--- /dev/null
+++ b/drivers/staging/lustrefsx/Makefile
@@ -0,0 +1,3 @@
+obj-$(CONFIG_LUSTREFSX_LNET)	+= lnet/
+obj-$(CONFIG_LUSTREFSX_FS)	+= lustre/
+obj-$(CONFIG_LUSTREFSX_LIBCFS)	+= libcfs/
diff --git a/drivers/staging/lustrefsx/Makefile.rules b/drivers/staging/lustrefsx/Makefile.rules
new file mode 100644
index 000000000000..a0d56e80f2ce
--- /dev/null
+++ b/drivers/staging/lustrefsx/Makefile.rules
@@ -0,0 +1,6 @@
+ccflags-y += -include $(srctree)/drivers/staging/lustrefsx/undef.h
+ccflags-y += -include $(srctree)/drivers/staging/lustrefsx/config.h
+ccflags-y += -I$(srctree)/drivers/staging/lustrefsx/libcfs/include
+ccflags-y += -I$(srctree)/drivers/staging/lustrefsx/lnet/include
+ccflags-y += -I$(srctree)/drivers/staging/lustrefsx/lustre/include
+ccflags-y += -Wno-format-truncation -Werror
diff --git a/drivers/staging/lustrefsx/libcfs/Kconfig b/drivers/staging/lustrefsx/libcfs/Kconfig
new file mode 100644
index 000000000000..3675b8381af2
--- /dev/null
+++ b/drivers/staging/lustrefsx/libcfs/Kconfig
@@ -0,0 +1,3 @@
+config LUSTREFSX_LIBCFS
+	depends on m
+	tristate "Lustre helper library"
diff --git a/drivers/staging/lustrefsx/libcfs/Makefile b/drivers/staging/lustrefsx/libcfs/Makefile
new file mode 100644
index 000000000000..6c5ff83ac791
--- /dev/null
+++ b/drivers/staging/lustrefsx/libcfs/Makefile
@@ -0,0 +1 @@
+obj-$(CONFIG_LUSTREFSX_LIBCFS) +=	libcfs/
diff --git a/drivers/staging/lustrefsx/libcfs/libcfs/Makefile b/drivers/staging/lustrefsx/libcfs/libcfs/Makefile
new file mode 100644
index 000000000000..a487ba032934
--- /dev/null
+++ b/drivers/staging/lustrefsx/libcfs/libcfs/Makefile
@@ -0,0 +1,19 @@
+obj-$(CONFIG_LUSTREFSX_LIBCFS)	+= libcfs.o
+
+libcfs-linux-objs	:= linux-tracefile.o linux-debug.o linux-prim.o
+libcfs-linux-objs	+= linux-cpu.o linux-curproc.o linux-module.o
+libcfs-linux-objs	+= linux-crypto.o linux-crypto-adler.o
+libcfs-linux-objs	+= linux-crypto-crc32.o
+
+libcfs-linux-objs	:= $(addprefix linux/,$(libcfs-linux-objs))
+
+libcfs-all-objs		:= debug.o fail.o module.o tracefile.o watchdog.o
+libcfs-all-objs		+= libcfs_string.o hash.o prng.o workitem.o
+libcfs-all-objs		+= libcfs_cpu.o libcfs_mem.o libcfs_lock.o heap.o
+libcfs-all-objs		+= libcfs_ptask.o
+
+libcfs-y		+= $(libcfs-linux-objs) $(libcfs-all-objs)
+
+ccflags-y		+= -I$(src)
+
+include $(srctree)/drivers/staging/lustrefsx/Makefile.rules
diff --git a/drivers/staging/lustrefsx/list b/drivers/staging/lustrefsx/list
new file mode 100644
index 000000000000..c69f3dc259a2
--- /dev/null
+++ b/drivers/staging/lustrefsx/list
@@ -0,0 +1,26 @@
+./lustre/osc/Makefile
+./lustre/fid/Makefile
+./lustre/mdc/Makefile
+./lustre/Makefile
+./lustre/ptlrpc/Makefile
+./lustre/obdclass/Makefile
+./lustre/llite/Makefile
+./lustre/obdecho/Makefile
+./lustre/lov/Makefile
+./lustre/lmv/Makefile
+./lustre/mgc/Makefile
+./lustre/fld/Makefile
+./Makefile.rules
+./libcfs/libcfs/Makefile
+./libcfs/Makefile
+./Makefile
+./lnet/selftest/Makefile
+./lnet/Makefile
+./lnet/lnet/Makefile
+./lnet/klnds/socklnd/Makefile
+./lnet/klnds/Makefile
+./lnet/klnds/o2iblnd/Makefile
+./lustre/Kconfig
+./Kconfig
+./libcfs/Kconfig
+./lnet/Kconfig
diff --git a/drivers/staging/lustrefsx/lnet/Kconfig b/drivers/staging/lustrefsx/lnet/Kconfig
new file mode 100644
index 000000000000..0d0686a25fe1
--- /dev/null
+++ b/drivers/staging/lustrefsx/lnet/Kconfig
@@ -0,0 +1,37 @@
+config LUSTREFSX_LNET
+	tristate "Lustre networking subsystem (LNet)"
+	select LUSTREFSX_LIBCFS
+	depends on m
+	depends on INET
+	help
+	  The Lustre network layer, also known as LNet, is a networking abstaction
+	  level API that was initially created to allow Lustre Filesystem to utilize
+	  very different networks like tcp and ib verbs in a uniform way. In the
+	  case of Lustre routers only the LNet layer is required. Lately other
+	  projects are also looking into using LNet as their networking API as well.
+
+config LUSTREFSX_LNET_SELFTEST
+	tristate "Lustre networking self testing"
+	depends on m
+	depends on LUSTREFSX_LNET
+	help
+	  Choose Y here if you want to do lnet self testing. To compile this
+	  as a module, choose M here: the module will be called lnet_selftest.
+
+	  If unsure, say N.
+
+	  See also http://wiki.lustre.org/
+
+config LUSTREFSX_LNET_XPRT_IB
+	tristate "LNET infiniband support"
+	depends on m
+	depends on LUSTREFSX_LNET && INFINIBAND && INFINIBAND_ADDR_TRANS
+	default LUSTREFSX_LNET && INFINIBAND
+	help
+	  This option allows the LNET users to use infiniband as an
+	  RDMA-enabled transport.
+
+	  To compile this as a kernel module, choose M here and it will be
+	  called ko2iblnd.
+
+	  If unsure, say N.
diff --git a/drivers/staging/lustrefsx/lnet/Makefile b/drivers/staging/lustrefsx/lnet/Makefile
new file mode 100644
index 000000000000..85a225e57b29
--- /dev/null
+++ b/drivers/staging/lustrefsx/lnet/Makefile
@@ -0,0 +1,3 @@
+subdir-$(CONFIG_LUSTREFSX_LNET)			+=	lnet/
+subdir-$(CONFIG_LUSTREFSX_LNET)			+=	klnds/
+subdir-$(CONFIG_LUSTREFSX_LNET_SELFTEST)	+=	selftest/
diff --git a/drivers/staging/lustrefsx/lnet/klnds/Makefile b/drivers/staging/lustrefsx/lnet/klnds/Makefile
new file mode 100644
index 000000000000..cd375ca2cc67
--- /dev/null
+++ b/drivers/staging/lustrefsx/lnet/klnds/Makefile
@@ -0,0 +1,2 @@
+obj-y		+= o2iblnd/
+obj-y		+= socklnd/
diff --git a/drivers/staging/lustrefsx/lnet/klnds/o2iblnd/Makefile b/drivers/staging/lustrefsx/lnet/klnds/o2iblnd/Makefile
new file mode 100644
index 000000000000..5ce6dc99ffe1
--- /dev/null
+++ b/drivers/staging/lustrefsx/lnet/klnds/o2iblnd/Makefile
@@ -0,0 +1,5 @@
+obj-$(CONFIG_LUSTREFSX_LNET_XPRT_IB)	+= ko2iblnd.o
+
+ko2iblnd-y		:= o2iblnd.o o2iblnd_cb.o o2iblnd_modparams.o
+
+include $(srctree)/drivers/staging/lustrefsx/Makefile.rules
diff --git a/drivers/staging/lustrefsx/lnet/klnds/socklnd/Makefile b/drivers/staging/lustrefsx/lnet/klnds/socklnd/Makefile
new file mode 100644
index 000000000000..6e6ec925b891
--- /dev/null
+++ b/drivers/staging/lustrefsx/lnet/klnds/socklnd/Makefile
@@ -0,0 +1,6 @@
+obj-$(CONFIG_LUSTREFSX_LNET)	+= ksocklnd.o
+
+ksocklnd-y		:= socklnd.o socklnd_cb.o socklnd_lib.o
+ksocklnd-y		+= socklnd_modparams.o socklnd_proto.o
+
+include $(srctree)/drivers/staging/lustrefsx/Makefile.rules
diff --git a/drivers/staging/lustrefsx/lnet/lnet/Makefile b/drivers/staging/lustrefsx/lnet/lnet/Makefile
new file mode 100644
index 000000000000..330de0a67065
--- /dev/null
+++ b/drivers/staging/lustrefsx/lnet/lnet/Makefile
@@ -0,0 +1,8 @@
+obj-$(CONFIG_LUSTREFSX_LNET)	+= lnet.o
+
+lnet-y 		:= api-ni.o config.o nidstrings.o
+lnet-y		+= lib-me.o lib-msg.o lib-eq.o lib-md.o lib-ptl.o
+lnet-y		+= lib-socket.o lib-move.o module.o lo.o
+lnet-y		+= router.o router_proc.o acceptor.o peer.o net_fault.o
+
+include $(srctree)/drivers/staging/lustrefsx/Makefile.rules
diff --git a/drivers/staging/lustrefsx/lnet/selftest/Makefile b/drivers/staging/lustrefsx/lnet/selftest/Makefile
new file mode 100644
index 000000000000..5380812715f7
--- /dev/null
+++ b/drivers/staging/lustrefsx/lnet/selftest/Makefile
@@ -0,0 +1,6 @@
+obj-$(CONFIG_LUSTREFSX_LNET_SELFTEST)	+= lnet_selftest.o
+
+lnet_selftest-y 	:= console.o conrpc.o conctl.o framework.o timer.o
+lnet_selftest-y		+= rpc.o module.o ping_test.o brw_test.o
+
+include $(srctree)/drivers/staging/lustrefsx/Makefile.rules
diff --git a/drivers/staging/lustrefsx/lustre/Kconfig b/drivers/staging/lustrefsx/lustre/Kconfig
new file mode 100644
index 000000000000..c565c870d805
--- /dev/null
+++ b/drivers/staging/lustrefsx/lustre/Kconfig
@@ -0,0 +1,41 @@
+config LUSTREFSX_FS
+	tristate "Lustre file system client support"
+	depends on m
+	select LUSTREFSX_LIBCFS
+	depends on LUSTREFSX_LNET
+	select CRYPTO
+	select CRYPTO_CRC32
+	select CRYPTO_CRC32_PCLMUL if X86
+	select CRYPTO_CRC32C
+	select CRYPTO_MD5
+	select CRYPTO_SHA1
+	select CRYPTO_SHA256
+	select CRYPTO_SHA512
+	depends on MULTIUSER
+	help
+	  This option enables Lustre file system client support. Choose Y
+	  here if you want to access a Lustre file system cluster. To compile
+	  this file system support as a module, choose M here: the module will
+	  be called lustre.
+
+	  To mount Lustre file systems, you also need to install the user space
+	  mount.lustre and other user space commands which can be found in the
+	  lustre-client package.
+
+	  Lustre file system is the most popular cluster file system in high
+	  performance computing. Source code of both kernel space and user space
+	  Lustre components can also be found at
+	  http://git.whamcloud.com/?p=fs/lustre-release.git;a=summary
+
+	  If unsure, say N.
+
+	  See also http://wiki.lustre.org/
+
+config LUSTRE_DEBUG_EXPENSIVE_CHECK
+	bool "Enable Lustre DEBUG checks"
+	depends on LUSTREFSX_FS
+	help
+	  This option is mainly for debug purpose. It enables Lustre code to do
+	  expensive checks that may have a performance impact.
+
+	  Use with caution. If unsure, say N.
diff --git a/drivers/staging/lustrefsx/lustre/Makefile b/drivers/staging/lustrefsx/lustre/Makefile
new file mode 100644
index 000000000000..207cab53c063
--- /dev/null
+++ b/drivers/staging/lustrefsx/lustre/Makefile
@@ -0,0 +1,8 @@
+obj-$(CONFIG_LUSTREFSX_FS) += fid/
+obj-$(CONFIG_LUSTREFSX_FS) += obdclass/
+obj-$(CONFIG_LUSTREFSX_FS) += ptlrpc/
+obj-$(CONFIG_LUSTREFSX_FS) += obdecho/
+obj-$(CONFIG_LUSTREFSX_FS) += mgc/
+obj-$(CONFIG_LUSTREFSX_FS) += lov/ osc/ mdc/ lmv/ llite/ fld/
+
+include $(srctree)/drivers/staging/lustrefsx/Makefile.rules
diff --git a/drivers/staging/lustrefsx/lustre/fid/Makefile b/drivers/staging/lustrefsx/lustre/fid/Makefile
new file mode 100644
index 000000000000..22be6773ba08
--- /dev/null
+++ b/drivers/staging/lustrefsx/lustre/fid/Makefile
@@ -0,0 +1,5 @@
+obj-$(CONFIG_LUSTREFSX_LNET)	+= fid.o
+
+fid-y		:= fid_request.o lproc_fid.o
+
+include $(srctree)/drivers/staging/lustrefsx/Makefile.rules
diff --git a/drivers/staging/lustrefsx/lustre/fld/Makefile b/drivers/staging/lustrefsx/lustre/fld/Makefile
new file mode 100644
index 000000000000..722c19fe3040
--- /dev/null
+++ b/drivers/staging/lustrefsx/lustre/fld/Makefile
@@ -0,0 +1,8 @@
+obj-$(CONFIG_LUSTREFSX_LNET)        += fld.o
+
+ccflags-y	+= -I$(srctree)/drivers/staging/lustrefsx/include
+
+fld-y		:= fld_request.o fld_cache.o lproc_fld.o
+
+include $(srctree)/drivers/staging/lustrefsx/Makefile.rules
+
diff --git a/drivers/staging/lustrefsx/lustre/llite/Makefile b/drivers/staging/lustrefsx/lustre/llite/Makefile
new file mode 100644
index 000000000000..96430e764665
--- /dev/null
+++ b/drivers/staging/lustrefsx/lustre/llite/Makefile
@@ -0,0 +1,13 @@
+obj-$(CONFIG_LUSTREFSX_FS)	+= lustre.o
+
+lustre-y	:= dcache.o dir.o file.o llite_lib.o llite_nfs.o
+lustre-y	+= rw.o lproc_llite.o namei.o symlink.o llite_mmap.o
+lustre-y	+= xattr.o xattr_cache.o
+lustre-y	+= rw26.o super25.o statahead.o xattr_security.o
+lustre-y	+= glimpse.o
+lustre-y	+= lcommon_cl.o
+lustre-y	+= lcommon_misc.o
+lustre-y	+= vvp_dev.o vvp_page.o vvp_lock.o vvp_io.o vvp_object.o
+lustre-y	+= range_lock.o
+
+include $(srctree)/drivers/staging/lustrefsx/Makefile.rules
diff --git a/drivers/staging/lustrefsx/lustre/lmv/Makefile b/drivers/staging/lustrefsx/lustre/lmv/Makefile
new file mode 100644
index 000000000000..40626f49283f
--- /dev/null
+++ b/drivers/staging/lustrefsx/lustre/lmv/Makefile
@@ -0,0 +1,5 @@
+obj-$(CONFIG_LUSTREFSX_FS)	+= lmv.o
+
+lmv-y	:= lmv_obd.o lmv_intent.o lmv_fld.o lproc_lmv.o
+
+include $(srctree)/drivers/staging/lustrefsx/Makefile.rules
diff --git a/drivers/staging/lustrefsx/lustre/lov/Makefile b/drivers/staging/lustrefsx/lustre/lov/Makefile
new file mode 100644
index 000000000000..e74389ed4c3e
--- /dev/null
+++ b/drivers/staging/lustrefsx/lustre/lov/Makefile
@@ -0,0 +1,8 @@
+obj-$(CONFIG_LUSTREFSX_FS)	+= lov.o
+
+lov-y	:= lov_dev.o lov_ea.o lov_io.o lov_lock.o lov_merge.o lov_obd.o
+lov-y	+= lov_object.o lov_offset.o lov_pack.o lov_page.o lov_pool.o
+lov-y	+= lov_request.o lovsub_dev.o lovsub_lock.o lovsub_object.o
+lov-y	+= lovsub_page.o lproc_lov.o
+
+include $(srctree)/drivers/staging/lustrefsx/Makefile.rules
diff --git a/drivers/staging/lustrefsx/lustre/mdc/Makefile b/drivers/staging/lustrefsx/lustre/mdc/Makefile
new file mode 100644
index 000000000000..e13d6af6f994
--- /dev/null
+++ b/drivers/staging/lustrefsx/lustre/mdc/Makefile
@@ -0,0 +1,6 @@
+obj-$(CONFIG_LUSTREFSX_FS)	+= mdc.o
+
+mdc-y		:= mdc_request.o mdc_reint.o lproc_mdc.o mdc_lib.o mdc_locks.o
+mdc-y		+= mdc_changelog.o
+
+include $(srctree)/drivers/staging/lustrefsx/Makefile.rules
diff --git a/drivers/staging/lustrefsx/lustre/mgc/Makefile b/drivers/staging/lustrefsx/lustre/mgc/Makefile
new file mode 100644
index 000000000000..7353c95e42cc
--- /dev/null
+++ b/drivers/staging/lustrefsx/lustre/mgc/Makefile
@@ -0,0 +1,5 @@
+obj-$(CONFIG_LUSTREFSX_FS)	+= mgc.o
+
+mgc-y	:= mgc_request.o lproc_mgc.o
+
+include $(srctree)/drivers/staging/lustrefsx/Makefile.rules
diff --git a/drivers/staging/lustrefsx/lustre/obdclass/Makefile b/drivers/staging/lustrefsx/lustre/obdclass/Makefile
new file mode 100644
index 000000000000..57450ea2824c
--- /dev/null
+++ b/drivers/staging/lustrefsx/lustre/obdclass/Makefile
@@ -0,0 +1,16 @@
+obj-$(CONFIG_LUSTREFSX_FS)	+= obdclass.o
+
+obdclass-linux-objs := linux-module.o linux-obdo.o linux-sysctl.o
+obdclass-linux-objs := $(addprefix linux/,$(obdclass-linux-objs))
+
+obdclass-y := $(obdclass-linux-objs)
+obdclass-y += llog.o llog_cat.o llog_obd.o llog_swab.o llog_osd.o
+obdclass-y += class_obd.o debug.o genops.o uuid.o llog_ioctl.o
+obdclass-y += lprocfs_status.o lprocfs_counters.o
+obdclass-y += lustre_handles.o lustre_peer.o local_storage.o
+obdclass-y += statfs_pack.o obdo.o obd_config.o obd_mount.o
+obdclass-y += lu_object.o dt_object.o
+obdclass-y += cl_object.o cl_page.o cl_lock.o cl_io.o lu_ref.o
+obdclass-y += linkea.o kernelcomm.o
+
+include $(srctree)/drivers/staging/lustrefsx/Makefile.rules
diff --git a/drivers/staging/lustrefsx/lustre/obdecho/Makefile b/drivers/staging/lustrefsx/lustre/obdecho/Makefile
new file mode 100644
index 000000000000..8fdb779fdc08
--- /dev/null
+++ b/drivers/staging/lustrefsx/lustre/obdecho/Makefile
@@ -0,0 +1,5 @@
+obj-$(CONFIG_LUSTREFSX_FS)	+= obdecho.o
+
+obdecho-y	:= echo_client.o
+
+include $(srctree)/drivers/staging/lustrefsx/Makefile.rules
diff --git a/drivers/staging/lustrefsx/lustre/osc/Makefile b/drivers/staging/lustrefsx/lustre/osc/Makefile
new file mode 100644
index 000000000000..223e42283bf9
--- /dev/null
+++ b/drivers/staging/lustrefsx/lustre/osc/Makefile
@@ -0,0 +1,6 @@
+obj-$(CONFIG_LUSTREFSX_FS)	+= osc.o
+
+osc-y := osc_request.o lproc_osc.o osc_dev.o osc_object.o osc_page.o
+osc-y += osc_lock.o osc_io.o osc_quota.o osc_cache.o
+
+include $(srctree)/drivers/staging/lustrefsx/Makefile.rules
diff --git a/drivers/staging/lustrefsx/lustre/ptlrpc/Makefile b/drivers/staging/lustrefsx/lustre/ptlrpc/Makefile
new file mode 100644
index 000000000000..f19231359782
--- /dev/null
+++ b/drivers/staging/lustrefsx/lustre/ptlrpc/Makefile
@@ -0,0 +1,26 @@
+obj-$(CONFIG_LUSTREFSX_FS)	+= ptlrpc.o
+
+LDLM := ../../lustre/ldlm/
+TARGET := ../../lustre/target/
+
+ldlm_objs := $(LDLM)l_lock.o $(LDLM)ldlm_lock.o
+ldlm_objs += $(LDLM)ldlm_resource.o $(LDLM)ldlm_lib.o
+ldlm_objs += $(LDLM)ldlm_plain.o $(LDLM)ldlm_extent.o
+ldlm_objs += $(LDLM)ldlm_request.o $(LDLM)ldlm_lockd.o
+ldlm_objs += $(LDLM)ldlm_flock.o $(LDLM)ldlm_inodebits.o
+ldlm_objs += $(LDLM)ldlm_pool.o $(LDLM)interval_tree.o
+ldlm_objs += $(LDLM)ldlm_reclaim.o
+
+ptlrpc_objs := client.o recover.o connection.o niobuf.o pack_generic.o
+ptlrpc_objs += events.o ptlrpc_module.o service.o pinger.o
+ptlrpc_objs += llog_net.o llog_client.o llog_server.o import.o ptlrpcd.o
+ptlrpc_objs += pers.o lproc_ptlrpc.o wiretest.o layout.o
+ptlrpc_objs += sec.o sec_ctx.o sec_bulk.o sec_gc.o sec_config.o sec_lproc.o
+ptlrpc_objs += sec_null.o sec_plain.o nrs.o nrs_fifo.o nrs_crr.o nrs_orr.o
+ptlrpc_objs += nrs_tbf.o nrs_delay.o errno.o
+
+ptlrpc-y	:= $(ldlm_objs) $(ptlrpc_objs) $(TARGET)barrier.o
+
+ccflags-y	+= -I$(srctree)/drivers/staging/lustrefsx/ldlm
+
+include $(srctree)/drivers/staging/lustrefsx/Makefile.rules
-- 
2.32.0

